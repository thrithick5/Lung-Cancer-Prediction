<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Lung Cancer Detection</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles and components */
        
        body {
            font-family: 'Inter', sans-serif;
            padding-top: 100px;
            /* Adjusted for header */
        }
        
        header {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }
        
        .interactive-card {
            transition: all 0.3s ease-in-out;
        }
        
        .interactive-card:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.07);
        }
        
        .interactive-button {
            transition: all 0.2s ease-in-out;
        }
        
        .interactive-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px -5px rgba(79, 70, 229, 0.4);
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        /* Form styling using utility classes in HTML now */
        
        .form-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px 12px;
            padding-right: 40px;
        }
    </style>
</head>

<body class="antialiased bg-slate-50 text-slate-700">

    <header class="bg-white/80 border-b border-slate-200">
        <div class="container mx-auto flex justify-between items-center p-4 md:p-6">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">AI Lung Cancer Detection</h1>
                <p class="text-slate-500 mt-1 text-sm">Advanced analysis for early detection.</p>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/" class="p-2 rounded-full hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 interactive-button" title="Go to Homepage">
                    <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                </a>
                <div id="modelStatus" class="flex items-center space-x-2 text-sm font-semibold">
                    <div id="modelStatusDot" class="w-3 h-3 rounded-full bg-gray-400 animate-pulse"></div>
                    <span id="modelStatusText" class="text-slate-500">Connecting...</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <main>
            <div id="content-analysis">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-5 space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 interactive-card">
                            <h2 class="text-lg font-semibold text-slate-800 mb-6">1. Patient Information</h2>
                            <form id="patientForm" class="space-y-6">
                                <div>
                                    <label for="patientName" class="block mb-2 text-sm font-semibold text-slate-700">Patient Name *</label>
                                    <input type="text" id="patientName" name="patientName" required class="w-full bg-white border-2 border-slate-200 rounded-md p-3 text-sm shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Enter patient's full name" minlength="2">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="patientAge" class="block mb-2 text-sm font-semibold text-slate-700">Age *</label>
                                        <input type="number" id="patientAge" name="patientAge" required class="w-full bg-white border-2 border-slate-200 rounded-md p-3 text-sm shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Age" min="1" max="120">
                                    </div>
                                    <div>
                                        <label for="patientGender" class="block mb-2 text-sm font-semibold text-slate-700">Gender *</label>
                                        <select id="patientGender" name="patientGender" required class="form-select w-full bg-white border-2 border-slate-200 rounded-md p-3 text-sm shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                            <option value="">Select gender</option>
                                            <option value="Male">Male</option>
                                            <option value="Female">Female</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label for="smokingHistory" class="block mb-2 text-sm font-semibold text-slate-700">Smoking History *</label>
                                    <select id="smokingHistory" name="smokingHistory" required class="form-select w-full bg-white border-2 border-slate-200 rounded-md p-3 text-sm shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                        <option value="">Select history</option>
                                        <option value="Never Smoked">Never Smoked</option>
                                        <option value="Former Smoker">Former Smoker</option>
                                        <option value="Current Smoker">Current Smoker</option>
                                    </select>
                                </div>
                            </form>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 interactive-card">
                            <h2 class="text-lg font-semibold text-slate-800 mb-4">2. Upload CT Scans</h2>
                            <div id="imageUploadArea" class="mt-1 flex justify-center rounded-md border-2 border-dashed border-slate-300 px-6 pt-5 pb-6 hover:border-indigo-500 cursor-pointer transition-colors duration-200">
                                <div class="space-y-1 text-center">
                                    <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                    <div class="flex text-sm text-slate-600">
                                        <label for="imageInput" class="relative cursor-pointer rounded-md bg-transparent font-medium text-indigo-600 hover:text-indigo-500">
                                            <span>Upload files</span>
                                            <input id="imageInput" name="images" type="file" class="sr-only" multiple accept=".jpg,.jpeg,.png">
                                        </label>
                                        <p class="pl-1">or drag and drop</p>
                                    </div>
                                    <p class="text-xs text-slate-500">PNG, JPG, JPEG up to 10MB</p>
                                </div>
                            </div>
                            <div id="fileList" class="mt-4 space-y-2"></div>
                        </div>

                        <div class="flex space-x-4">
                            <button id="analyzeBtn" type="button" class="w-full inline-flex justify-center items-center rounded-md bg-indigo-600 px-6 py-3 text-base font-medium text-white shadow-sm hover:bg-indigo-700 disabled:bg-indigo-300 interactive-button">Analyze</button>
                            <button id="clearBtn" type="button" class="w-full inline-flex justify-center rounded-md border border-slate-300 bg-white px-6 py-3 text-base font-medium text-slate-700 shadow-sm hover:bg-slate-50 interactive-button">Clear</button>
                        </div>
                    </div>

                    <div class="lg:col-span-7">
                        <div id="resultsContainer" class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 interactive-card min-h-[400px]">
                            <div id="resultsPlaceholder" class="flex flex-col items-center justify-center h-full text-center">
                                <svg class="w-16 h-16 text-slate-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg>
                                <h3 class="mt-4 text-lg font-semibold text-slate-800">Analysis Results</h3>
                                <p class="mt-1 text-sm text-slate-500">Results will be displayed here after analysis.</p>
                            </div>
                            <div id="resultsLoading" class="hidden flex-col items-center justify-center h-full">
                                <div class="spinner"></div>
                                <p class="mt-4 text-slate-600">Analyzing images, please wait...</p>
                            </div>
                            <div id="resultsContent" class="hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                API_BASE_URL: 'http://localhost:5008',
                analysis: {
                    form: document.getElementById('patientForm'),
                    uploadArea: document.getElementById('imageUploadArea'),
                    imageInput: document.getElementById('imageInput'),
                    fileList: document.getElementById('fileList'),
                    analyzeBtn: document.getElementById('analyzeBtn'),
                    clearBtn: document.getElementById('clearBtn'),
                },
                results: {
                    placeholder: document.getElementById('resultsPlaceholder'),
                    loading: document.getElementById('resultsLoading'),
                    content: document.getElementById('resultsContent'),
                },
                modelStatus: {
                    dot: document.getElementById('modelStatusDot'),
                    text: document.getElementById('modelStatusText'),
                },
                selectedFiles: [],

                init() {
                    this.checkModelStatus();
                    this.bindEvents();
                },

                bindEvents() {
                    this.analysis.uploadArea.addEventListener('click', () => this.analysis.imageInput.click());
                    this.analysis.imageInput.addEventListener('change', (e) => this.handleFileSelect(e.target.files));
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        this.analysis.uploadArea.addEventListener(eventName, this.preventDefaults, false);
                    });
                    this.analysis.uploadArea.addEventListener('drop', (e) => this.handleFileSelect(e.dataTransfer.files), false);
                    this.analysis.analyzeBtn.addEventListener('click', () => this.runAnalysis());
                    this.analysis.clearBtn.addEventListener('click', () => this.clearForm());
                },

                preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                },

                async checkModelStatus() {
                    try {
                        const response = await fetch(`${this.API_BASE_URL}/model_status`);
                        if (!response.ok) throw new Error(`Server responded with status ${response.status}`);
                        const data = await response.json();
                        if (data.loaded) {
                            this.modelStatus.dot.className = 'w-3 h-3 rounded-full bg-green-500';
                            this.modelStatus.text.className = 'font-semibold text-green-600';
                            this.modelStatus.text.textContent = 'Model Ready';
                        } else {
                            throw new Error(data.message || 'Model not loaded on backend.');
                        }
                    } catch (e) {
                        console.error("Model status check failed:", e);
                        this.modelStatus.dot.className = 'w-3 h-3 rounded-full bg-red-500';
                        this.modelStatus.text.className = 'font-semibold text-red-600';
                        this.modelStatus.text.textContent = 'Connection Error';

                        this.results.placeholder.classList.add('hidden');
                        this.results.loading.classList.add('hidden');
                        this.results.content.classList.remove('hidden');
                        this.results.content.innerHTML = `
                            <div class="flex flex-col items-center justify-center h-full text-center">
                                <svg class="w-16 h-16 text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
                                </svg>
                                <h3 class="mt-4 text-lg font-semibold text-red-700">Connection to Backend Failed</h3>
                                <p class="mt-1 text-sm text-slate-500">
                                    Could not connect to the analysis server at <strong>${this.API_BASE_URL}</strong>.
                                    <br>Please ensure the backend Python script ('app.py') is running and accessible.
                                </p>
                                <p class="mt-2 text-xs text-slate-400">Error details: ${e.message}</p>
                            </div>
                        `;
                    }
                },

                handleFileSelect(files) {
                    this.selectedFiles = Array.from(files);
                    this.analysis.fileList.innerHTML = '';
                    if (this.selectedFiles.length > 0) {
                        const list = document.createElement('ul');
                        list.className = 'divide-y divide-slate-200';
                        this.selectedFiles.forEach(file => {
                            const li = document.createElement('li');
                            li.className = 'py-2 flex justify-between items-center text-sm';
                            li.innerHTML = `<span class="text-slate-800">${file.name}</span><span class="text-xs text-slate-500">${(file.size/1024).toFixed(1)} KB</span>`;
                            list.appendChild(li);
                        });
                        this.analysis.fileList.appendChild(list);
                    }
                },

                clearForm() {
                    this.analysis.form.reset();
                    this.selectedFiles = [];
                    this.analysis.fileList.innerHTML = '';
                    this.analysis.imageInput.value = '';
                    this.results.placeholder.classList.remove('hidden');
                    this.results.content.classList.add('hidden');
                    this.results.loading.classList.add('hidden');
                    this.results.content.innerHTML = '';
                    this.analysis.analyzeBtn.disabled = false;
                },

                validateForm() {
                    if (!this.analysis.form.checkValidity()) {
                        alert("Please fill out all required patient information fields correctly.");
                        return false;
                    }
                    if (this.selectedFiles.length === 0) {
                        alert("Please upload at least one CT scan image.");
                        return false;
                    }
                    return true;
                },

                async runAnalysis() {
                    if (!this.validateForm()) return;

                    this.results.placeholder.classList.add('hidden');
                    this.results.loading.classList.remove('hidden');
                    this.results.content.classList.add('hidden');
                    this.analysis.analyzeBtn.disabled = true;

                    const formData = new FormData(this.analysis.form);
                    this.selectedFiles.forEach(file => formData.append('images', file));

                    try {
                        const res = await fetch(`${this.API_BASE_URL}/predict`, {
                            method: 'POST',
                            body: formData
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || 'Analysis failed');
                        this.displayResults(data);
                    } catch (e) {
                        this.results.content.innerHTML = `
                            <div class="flex flex-col items-center justify-center h-full text-center">
                                <svg class="w-16 h-16 text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
                                </svg>
                                <h3 class="mt-4 text-lg font-semibold text-red-700">Analysis Failed</h3>
                                <p class="mt-1 text-sm text-slate-500">An error occurred during the analysis. Please try again or check the server logs.</p>
                                <p class="mt-2 text-xs text-slate-400">Error details: ${e.message}</p>
                            </div>
                        `;
                    } finally {
                        this.results.loading.classList.add('hidden');
                        this.results.content.classList.remove('hidden');
                        this.analysis.analyzeBtn.disabled = false;
                    }
                },

                displayResults(data) {
                    const {
                        patient_info,
                        results
                    } = data;

                    let html = `<h3 class="text-xl font-bold text-slate-800 mb-2">Analysis for ${patient_info.patientName}</h3>`;
                    html += `<div class="text-sm text-slate-600 mb-6 bg-slate-100 p-3 rounded-lg">
                        <strong>Patient Details:</strong> Age: ${patient_info.patientAge}, Gender: ${patient_info.patientGender}, Smoking: ${patient_info.smokingHistory}
                    </div>`;

                    html += '<div class="space-y-4">';

                    results.forEach(r => {
                        if (r.error) {
                            html += `<div class="p-4 mb-4 border bg-red-50 border-red-200 rounded-lg"><p class="font-medium text-red-800">${r.filename}</p><p class="text-sm text-red-600">Error: ${r.error}</p></div>`;
                        } else {
                            const getBadgeClass = (className) => {
                                switch (className) {
                                    case 'Malignant':
                                        return 'bg-red-100 text-red-800 border-red-200';
                                    case 'Beginning':
                                        return 'bg-yellow-100 text-yellow-800 border-yellow-200';
                                    default:
                                        return 'bg-gray-100 text-gray-800 border-gray-200';
                                }
                            };

                            const getRiskColor = (className) => {
                                switch (className) {
                                    case 'Malignant':
                                        return 'text-red-600';
                                    case 'Beginning':
                                        return 'text-yellow-500';
                                    default:
                                        return 'text-gray-600';
                                }
                            };

                            const getDiagnosisText = (className) => {
                                if (className === 'Malignant') {
                                    return 'High risk detected. Immediate consultation with a specialist is strongly recommended.';
                                }
                                if (className === 'Beginning') {
                                    return 'Potential early-stage indicators found. Consultation with a doctor is advised for further evaluation.';
                                }
                                return 'No immediate malignant indicators found. Continue with regular check-ups.';
                            };


                            const badgeClass = getBadgeClass(r.predicted_class_name);
                            const riskColor = getRiskColor(r.predicted_class_name);
                            const diagnosisText = getDiagnosisText(r.predicted_class_name);

                            html += `
                                <div class="p-4 border border-slate-200 rounded-lg bg-slate-50">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-medium text-slate-800">${r.filename}</p>
                                            <div class="mt-2">
                                                <span class="px-3 py-1 rounded-full text-xs font-semibold border ${badgeClass}">
                                                    ${r.predicted_class_name}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="text-right flex-shrink-0 ml-4">
                                            <p class="font-bold text-3xl ${riskColor}">${r.confidence_percentage}%</p>
                                            <p class="text-xs text-slate-500">Confidence</p>
                                        </div>
                                    </div>
                                    <div class="mt-4 pt-4 border-t border-slate-200">
                                        <h4 class="font-semibold text-slate-800">Recommendation</h4>
                                        <p class="text-sm text-slate-600 mt-1">${diagnosisText}</p>
                                    </div>
                                </div>
                            `;
                        }
                    });

                    html += '</div>';
                    this.results.content.innerHTML = html;
                }
            };
            app.init();
        });
    </script>
</body>

</html>